<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Caching Memory Allocator · AMDGPU.jl</title><meta name="title" content="Caching Memory Allocator · AMDGPU.jl"/><meta property="og:title" content="Caching Memory Allocator · AMDGPU.jl"/><meta property="twitter:title" content="Caching Memory Allocator · AMDGPU.jl"/><meta name="description" content="Documentation for AMDGPU.jl."/><meta property="og:description" content="Documentation for AMDGPU.jl."/><meta property="twitter:description" content="Documentation for AMDGPU.jl."/><meta property="og:url" content="https://amdgpu.juliagpu.org/stable/caching_allocator/"/><meta property="twitter:url" content="https://amdgpu.juliagpu.org/stable/caching_allocator/"/><link rel="canonical" href="https://amdgpu.juliagpu.org/stable/caching_allocator/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154489943-2"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-154489943-2', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="AMDGPU.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">AMDGPU.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Quick Start</a></li><li><a class="tocitem" href="../devices/">Devices</a></li><li><a class="tocitem" href="../streams/">Streams</a></li><li><a class="tocitem" href="../kernel_programming/">Kernel Programming</a></li><li><a class="tocitem" href="../exceptions/">Exceptions</a></li><li><a class="tocitem" href="../profiling/">Profiling</a></li><li><a class="tocitem" href="../memory/">Memory</a></li><li class="is-active"><a class="tocitem" href>Caching Memory Allocator</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#API"><span>API</span></a></li></ul></li><li><a class="tocitem" href="../hostcall/">Host-Call</a></li><li><a class="tocitem" href="../printing/">Printing</a></li><li><a class="tocitem" href="../logging/">Logging</a></li><li><a class="tocitem" href="../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Caching Memory Allocator</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Caching Memory Allocator</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaGPU/AMDGPU.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaGPU/AMDGPU.jl/blob/master/docs/src/caching_allocator.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Caching-Memory-Allocator"><a class="docs-heading-anchor" href="#Caching-Memory-Allocator">Caching Memory Allocator</a><a id="Caching-Memory-Allocator-1"></a><a class="docs-heading-anchor-permalink" href="#Caching-Memory-Allocator" title="Permalink"></a></h1><p>Julia uses Garbage-Collection (GC) for automatic memory management. However, it does not know about other memory spaces, therefore it sees no difference between 1 KiB GPU allocation and 1 GiB and doesn&#39;t free it in time.</p><p>This leads to a situations where all of the GPU memory is used, even though your algorithm only requires a fraction of it.</p><p>Current mechanism of dealing with OOM (Out-Of-Memory) errors during allocations is to manually trigger GC and retry allocating again doing this in several rounds each more aggressive than previous.</p><p>However, manually triggering GC is very expensive, since it requires scanning all Julia objects, not just ROCArrays, so the actual memory freeing takes a fraction of GC time: <img src="../assets/gc-vram-breakdown.png" alt/></p><p>On the image above, red region is a call to GC and green region is where actual GPU memory is being freed.</p><hr/><p>To help with memory management, we can use caching memory allocator. It is usefult in scenarios where we execute the same function multiple times and have the same memory allocation pattern. One such example is training DL models, where given the model and its parameters we compute loss, gradients w.r.t. loss and perform in-place parameter update. In this case, every iteration performs same operations and memory allocations and with caching allocator we can efficiently re-use them without returning the memory back to OS.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>We have a for-loop, where each iteration requires 2 GiB of VRAM. We create a caching allocator with the name <code>:loop</code> and pass a function to execute. First iteration will allocate, but subsequent won&#39;t.</p><pre><code class="language-julia hljs">using AMDGPU

function main()
    n = 1024^2 * 256
    for i in 1:1000
        AMDGPU.with_caching_allocator(:loop, n) do n
            sin.(AMDGPU.rand(Float32, n)) # 2 GiB allocation
            return
        end
    end
end</code></pre><p>The reason for marking a region of code where to re-use the memory and not extending it to the whole program instead, is because we cannot rely on GC to tell us when the memory is no longer used (it is too slow for that), so we create such region manually.</p><p>You can free all memory held by allocator, by invalidating it using its name with <a href="#AMDGPU.invalidate_caching_allocator!"><code>AMDGPU.invalidate_caching_allocator!</code></a>. Or if you want some region of code within <a href="#AMDGPU.with_caching_allocator"><code>AMDGPU.with_caching_allocator</code></a> to execute without relying on cache, use <a href="#AMDGPU.with_no_caching"><code>AMDGPU.with_no_caching</code></a>.</p><table><tr><th style="text-align: center"></th><th style="text-align: center">Without Caching Allocator</th><th style="text-align: center">With Caching Allocator</th></tr><tr><td style="text-align: center">VRAM Usage</td><td style="text-align: center"><img src="../assets/without-caching-allocator.png" alt/></td><td style="text-align: center"><img src="../assets/with-caching-allocator.png" alt/></td></tr><tr><td style="text-align: center">Execution time (seconds)</td><td style="text-align: center"><code>12.865149</code></td><td style="text-align: center"><code>0.020943</code></td></tr></table><h2 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="AMDGPU.with_caching_allocator" href="#AMDGPU.with_caching_allocator"><code>AMDGPU.with_caching_allocator</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">with_caching_allocator(f, alloc_name::Symbol, args...)</code></pre><p>Execute function <code>f</code> with arguments <code>args...</code> using caching allocator given by its name <code>alloc_name</code>.</p><p>All GPU memory allocations will attempt to hit this cache before doing actual allocation (in case of cache miss). After executing <code>f</code>, all &quot;busy&quot; memory within the allocator is marked as free, so it can be re-used with the next call.</p><p><strong>Returns</strong></p><p>Result of the <code>f</code> function.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaGPU/AMDGPU.jl/blob/2c93eda779b8af0dfa975c8bbb6e40c90bacdd76/src/caching_allocator.jl#L88-L102">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="AMDGPU.with_no_caching" href="#AMDGPU.with_no_caching"><code>AMDGPU.with_no_caching</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">with_no_caching(f)</code></pre><p>Execute function <code>f</code>, but avoid hitting any caching allocator. This is useful to call from within <a href="#AMDGPU.with_caching_allocator"><code>with_caching_allocator</code></a>, so that the memory is independent from it.</p><p><strong>Returns</strong></p><p>Result of the <code>f</code> function.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaGPU/AMDGPU.jl/blob/2c93eda779b8af0dfa975c8bbb6e40c90bacdd76/src/caching_allocator.jl#L114-L124">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="AMDGPU.invalidate_caching_allocator!" href="#AMDGPU.invalidate_caching_allocator!"><code>AMDGPU.invalidate_caching_allocator!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">invalidate_caching_allocator!(alloc_name::Symbol)</code></pre><p>Free all memory held by caching allocator given by it name <code>alloc_name</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaGPU/AMDGPU.jl/blob/2c93eda779b8af0dfa975c8bbb6e40c90bacdd76/src/caching_allocator.jl#L133-L137">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../memory/">« Memory</a><a class="docs-footer-nextpage" href="../hostcall/">Host-Call »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 24 December 2024 12:57">Tuesday 24 December 2024</span>. Using Julia version 1.10.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
